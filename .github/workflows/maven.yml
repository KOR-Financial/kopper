# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: kopper verify

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: [ self-hosted ]

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: "adopt"
          java-version: 17
          server-id: github
      - name: Set up Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: 3.5.4
      - shell: bash
        run: |
          set -ex
          mkdir -p ~/.m2
          echo -n "maven" > ~/.m2/type
          cat > ~/.m2/settings.xml << EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                http://maven.apache.org/xsd/settings-1.0.0.xsd">
          <activeProfiles>
           <activeProfile>github</activeProfile>
          </activeProfiles>
          <profiles>
           <profile>
             <id>github</id>
             <repositories>
               <repository>
                 <id>central</id>
                 <url>https://repo1.maven.org/maven2</url>
               </repository>
               <repository>
                 <id>github</id>
                 <url>https://maven.pkg.github.com/kor-financial/*</url>
                 <snapshots>
                   <enabled>true</enabled>
                 </snapshots>
               </repository>
             </repositories>
           </profile>
          </profiles>
          <servers>
           <server>
             <id>github</id>
             <username>${{ secrets.ROBOT_USERNAME }}</username>
             <password>${{ secrets.ROBOT_PAT }}</password>
           </server>
          </servers>
          </settings>
          EOF

      - name: Build with Maven
        run: mvn -B verify --file pom.xml
      - name: SonarCloud scan
        env:
          GITHUB_TOKEN: ${{ secrets.ROBOT_PAT }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B -U org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=KOR-Financial_kopper
